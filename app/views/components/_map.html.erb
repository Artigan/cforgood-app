<script>

    var geoJson = <%= raw(@geojson.to_json) %>;

    L.mapbox.accessToken = 'pk.eyJ1IjoiZnJlZHBldHJpcyIsImEiOiJjaWtoem9qd2IwMDJmdnBtNmZ0Y29zcG5sIn0.atyCUDfyMaoUauNY1diwtQ';

    var mapboxTiles = L.tileLayer('https://api.mapbox.com/v4/mapbox.streets/{z}/{x}/{y}.png?access_token=' + L.mapbox.accessToken, {
      attribution: '<a href="http://www.mapbox.com/about/maps/" target="_blank">Terms &amp; Feedback</a>'
    });

    var map = L.map('map-dashboard')
      .addLayer(mapboxTiles)
      .setView(["<%= current_user.latitude %>", "<%= current_user.longitude %>"], 14);

    // New Layer
    var mapLayer = L.mapbox.featureLayer().addTo(map);

    // Set a custom icon on each marker based on feature properties
    mapLayer.on('layeradd', function(e) {
      var marker = e.layer,
          feature = marker.feature;
      marker.setIcon(L.icon(feature.properties.icon));
      marker.bindPopup(feature.properties.popupContent,{
        closeButton: true
      });
    });

    // Center on marker click
    // mapLayer.on('click', function(e) {
    //   map.panTo(e.layer.getLatLng());
    // });

    // Add features to the map
    mapLayer.setGeoJSON(geoJson);

    // Fit around the markers of the map
    map.fitBounds(mapLayer.getBounds());

</script>
