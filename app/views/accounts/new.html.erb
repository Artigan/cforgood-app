<h1> Card registration </h1>

<div class="container-fluid">
  <div class="row">
    <div class="col-sm-4 col-sm-offset-4 mt-80 bg-light-white text-center">
      <form id="form-card-creation">
        <label for="card_number">Numéro de carte</label>
        <input type="text" name="card_number" id="card_number">
        </br>
        <label for="card_exp_date">Date d'expiration</label>
        <input type="text" name="card_exp_date" id="card_exp_date">
        </br>
        <label for="card_cvx">Numéro CVX</label>
        <input type="text" name="card_cvx" id="card_cvx">
        </br>
        <input type="submit" id="create-card">
      </form>
      <%= simple_form_for :card, url: accounts_path, html: { id: :create_account } do |f| %>
        <%= f.input :id, as: :hidden %>
        <%= f.submit %>
      <% end %>
    </div>
  </div>
</div>


<% content_for :after_js do %>

  <script>
    $(document).ready(function() {
      $("#form-card-creation").validate({
        rules: {
          card_number: {
            required: true,
          },
          card_expiration_date: {
            required: true,
          },
          cvx: {
            required: true,
          }
        }
      });

      $("#form-card-creation").on("submit", function(e) {
        e.preventDefault();
        if ($("#form-card-creation").valid()) {
          var cardPreRegistration = <%= current_user.mangopay_id ? raw(current_user.create_mangopay_card_pre_registration.to_json) : "null"  %>;

          // Initialize with card register data prepared on the server
          mangoPay.cardRegistration.init({
            cardRegistrationURL: cardPreRegistration.CardRegistrationURL,
            preregistrationData: cardPreRegistration.PreregistrationData,
            accessKey: cardPreRegistration.AccessKey,
            Id: cardPreRegistration.Id
          });

          // Card data collected from the user
          var cardData = {
           cardNumber: $("#card_number").val(),
           cardExpirationDate: $("#card_exp_date").val(),
           cardCvx: $("#card_cvx").val(),
           cardType: "CB_VISA_MASTERCARD"
           // cardType: $("#card_type").val()
          };

          // Set MangoPay API base URL and Client ID
          // mangoPay.cardRegistration.baseURL   = "<%= ENV['MANGOPAY_API_URL'] %>";
          // mangoPay.cardRegistration.clientId  = "<%= ENV['MANGOPAY_CLIENT_ID'] %>";
          mangoPay.cardRegistration.baseURL   = "https://api.sandbox.mangopay.com";
          mangoPay.cardRegistration.clientId  = "cforgood";
          var validateCard = mangoPay.cardRegistration._validateCardData(cardData);

          if (validateCard) {
            // Register card
            mangoPay.cardRegistration.registerCard(
              cardData,
              function(res) {
                $("#card_id").val(res.CardId);
                $("#create_account").submit();
                // alert("Votre carte a bien été enregistrée sous le numéro " + res.CardId)
                // Success, you can use res.CardId now that points to registered card
              },
              function(res) {
                alert("Une erreur s'est produite lors de l'enregistrement de votre carte : " + res.ResultMessage)
                // Handle error, see res.ResultCode and res.ResultMessage
              }
            );
          };
        };
      });
    });
  </script>

<% end %>
