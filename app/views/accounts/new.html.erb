 <style>
  .subscription-form form {
    display: block;
  }
</style>

<div class="container-fluid connexion connexion-user">
  <div class="connexion-overlay"></div>
    <div class="row">
      <!-- FORM SELECT CAUSE -->
      <div class="col-xs-12 col-sm-6 form-card form-select-cause">
        <div class="cause-selection">Choississez votre cause</div>
        <% Cause.all.sample(3).each do |cause| %>
          <%= link_to update_cause_path(cause_id: cause.id), method: :put, remote: true do %>
            <div class="col-xs-12 col-sm-6 col-md-4">
              <div class="row relative cause-card" >
                <div class="bg-cause-card" style="background-image: url(<%= cause.picture.url(:medium) %>)">
                  <div class="cause-popover" id="<%= cause.id %>", data-content="<%= cause.description %>" data-placement="bottom" data-original-title="<%= cause.name %>" data-trigger="hover">
                    <div class="row" id="cause-category">
                      <p><%= cause.cause_category.name %></p>
                    </div>
                    <div class="row" id="cause-info">
                      <div class="col-xs-12" id="cause-name">
                        <h1><%= cause.name.upcase %></h1>
                      </div>
                    </div>
                    <div class="row" id="cause-impact">
                      <p><%= cause.impact.upcase %></p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          <% end %>
        <% end %>
        <div class="form-list-causes">
          <%= simple_form_for :cause_id, url: update_cause_path, html: { id: :update_cause_id, method: :put, action: :update_cause, remote: true } do |f| %>
            <%= f.input :cause_id, id: "id", collection: Cause.all, label: false, prompt: ("Ou sélectionnez parmi les autres associations"), selected: current_user.cause_id %>
             <%= f.submit "", :style => "display: none;" %>
          <% end %>
        </div>
        <p>Sans choix de votre part, votre abonnement sera reversé à CforGood !</p>
      </div>
      <!-- FORM CARD REGISTRATION -->
      <div class="col-xs-12 col-sm-6 form-card form-payment">
        <span>S'abonner à CForGood</span>
        <div>
          Pour 5 € par mois
        </div>
        <div class="subscription-form">
          <form id="form-card-creation">
            <div class="form-group">
              <label for="card_number" class="control-label">Numéro de carte</label>
              <input type="text" name="card_number" id="card_number" size="18" class="form-control">
            </div>
            <div class="form-group">
              <label for="card_exp_date" class="control-label">Date d'expiration</label>
              <input type="text" name="card_exp_date" id="card_exp_date" size="6" placeholder='mmaa' class="form-control">
            </div>
            <div class="form-group">
              <label for="card_cvx" class="control-label">Cryptogramme visuel</label>
              <input type="text" name="card_cvx" id="card_cvx" size="4" class="form-control">
            </div>
            <input type="submit" value="Enregistrer votre carte"  id="create-card" class="btn btn-default">
          </form>
          <div class="hidden">
            <%= simple_form_for :card, url: accounts_path, html: { id: :create_account } do |f| %>
              <%= f.input :id, as: :hidden %>
              <%= f.submit "", :style => "display: none;" %>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<% content_for :after_js do %>

  <script>
    $(document).ready(function() {
      $(".bg-cause-card").bind('ajax:complete', function() {
      });

      $("#update_cause_id").change(function() {
        $("#update_cause_id").submit();
      });

      $(".cause-popover").popover({
        html: true,
        container: "body",
        trigger: "hover"
      });

      $("#form-card-creation").validate({
        rules: {
          card_number: {
            required: true,
            digits: true,
            minlength: 16,
            maxlength: 16

          },
          card_expiration_date: {
            required: true,
            digits: true,
            minlength: 4,
            maxlength: 4
          },
          cvx: {
            required: true,
            digits: true,
            minlength: 3,
            maxlength: 3
          }
        }
      });

      $("#form-card-creation").on("submit", function(e) {
        e.preventDefault();
        if ($("#form-card-creation").valid()) {
          var cardPreRegistration = <%= current_user.mangopay_id ? raw(current_user.create_mangopay_card_pre_registration.to_json) : "null"  %>;

          // Initialize with card register data prepared on the server
          mangoPay.cardRegistration.init({
            cardRegistrationURL: cardPreRegistration.CardRegistrationURL,
            preregistrationData: cardPreRegistration.PreregistrationData,
            accessKey: cardPreRegistration.AccessKey,
            Id: cardPreRegistration.Id
          });

          // Card data collected from the user
          var cardData = {
           cardNumber: $("#card_number").val(),
           cardExpirationDate: $("#card_exp_date").val(),
           cardCvx: $("#card_cvx").val(),
           cardType: "CB_VISA_MASTERCARD"
           // cardType: $("#card_type").val()
          };

          // Set MangoPay API base URL and Client ID
          mangoPay.cardRegistration.baseURL   = "<%= ENV['MANGOPAY_API_URL'] %>";
          mangoPay.cardRegistration.clientId  = "<%= ENV['MANGOPAY_CLIENT_ID'] %>";
          var validateCard = mangoPay.cardRegistration._validateCardData(cardData);

          if (validateCard) {
            // Register card
            mangoPay.cardRegistration.registerCard(
              cardData,
              function(res) {
                $("#card_id").val(res.CardId);
                $("#create_account").submit();
                // Success, you can use res.CardId now that points to registered card
              },
              function(res) {
                alert("Une erreur s'est produite lors de l'enregistrement de votre carte : " + res.ResultMessage)
                // Handle error, see res.ResultCode and res.ResultMessage
              }
            );
          };
        };
      });
    });
  </script>

<% end %>
