<h1> Card registration </h1>


<!-- 1. user want to pay ==> choose card > -->

  <form id="form-card-creation">
    <label for="card_number">Numéro de carte</label>
    <input type="text" name="card_number" id="card_number">
    </br>
    <label for="card_exp_date">Date d'expiration</label>
    <input type="text" name="card_exp_date" id="card_exp_date">
    </br>
    <label for="card_cvx">Numéro CVX</label>
    <input type="text" name="card_cvx" id="card_cvx">
    </br>
    <input type="submit" id="create-card">
  </form>

<!-- 2. create CardREgistration Object -->
<!-- 3. receive CardRegistration Object -->
<!-- 4. receive PreregistrationData AccessKey CardRegistrationURL  -->

<% content_for :after_js do %>

  <script>
    $(document).ready(function() {

      // $("#form-card-creation").validate({
      //   rules: {
      //     card_number: {
      //       required: true,
      //     },
      //     card_expiration_date: {
      //       required: true,
      //     },
      //     cvx: {
      //       required: true,
      //     }
      //   }
      // });

      $("#form-card-creation").submit(function(e) {
        e.preventDefault();
        var cardPreRegistration = <%= raw current_user.create_mangopay_card_pre_registration.to_json %>;

        // Initialize with card register data prepared on the server
        mangoPay.cardRegistration.init({
          cardRegistrationURL: cardPreRegistration.CardRegistrationURL,
          preregistrationData: cardPreRegistration.PreregistrationData,
          accessKey: cardPreRegistration.AccessKey,
          Id: cardPreRegistration.Id
        });

        // Card data collected from the user
        var cardData = {
         cardNumber: $("#card_number").val(),
         cardExpirationDate: $("#card_exp_date").val(),
         cardCvx: $("#card_cvx").val(),
         cardType: "CB_VISA_MASTERCARD"
         // cardType: $("#card_type").val()
        };

        // Set MangoPay API base URL and Client ID
        // mangoPay.cardRegistration.baseURL   = "<%= ENV['MANGOPAY_API_URL'] %>";
        // mangoPay.cardRegistration.clientId  = "<%= ENV['MANGOPAY_CLIENT_ID'] %>";
        mangoPay.cardRegistration.baseURL   = "https://api.sandbox.mangopay.com";
        mangoPay.cardRegistration.clientId  = "cforgood";
        var validateCard = mangoPay.cardRegistration._validateCardData(cardData);

        // Register card
        mangoPay.cardRegistration.registerCard(
          cardData,
          function(res) {
            alert(res.CardId)
            current_user.update_mangopay_card_id(res.CarId)
            // Success, you can use res.CardId now that points to registered card
          },
          function(res) {
            alert(res.ResultCod)
            // Handle error, see res.ResultCode and res.ResultMessage
          }
        );
      });
    });
  </script>
<% end %>
