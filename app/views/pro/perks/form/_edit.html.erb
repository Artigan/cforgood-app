<div class="dashboard-create-perk">
  <%= image_tag('logopouce.png', class: 'logo-title') %>
  <span class="view-title">Modifier le bon plan | <strong><%= @perk.name %></strong></span>

  <!-- CARDS PERK -->
  <%= render "pro/perks/form/cards_perk" %>

 <!-- FORMS PERK -->
  <%= render "pro/perks/form/forms_perk",  action: 'edit', submit_label: 'Modifier votre bon plan' %>
</div>

<!-- UPDATE PERK CONFIRMATION -->
<%= render "pro/perks/form/updated" %>

<% content_for :after_js do %>

  <script>

    $(document).ready(function() {

      // ACTIVE INITIAL PERK
      $('.dashboard').scrollTop(0);
      $(".dashboard-overlay").removeClass('hidden');
      if (<%= @perk.appel %>) {
        $("#type-create-appel").find('.fa-plus').addClass('plus-animation');
        $(".perk-appel").addClass('type-show');
        $("#type-create-appel").parents('.type-card').addClass('card-visible').siblings('.type-card').addClass('card-invisible');
      } else if (<%= @perk.durable %>) {
        $("#type-create-durable").find('.fa-plus').addClass('plus-animation');
        $(".perk-durable").addClass('type-show');
        $("#type-create-durable").parents('.type-card').addClass('card-visible').siblings('.type-card').addClass('card-invisible');
      } else {
        $("#type-create-flash").find('.fa-plus').addClass('plus-animation');
        $(".perk-flash").addClass('type-show');
        $("#type-create-flash").parents('.type-card').addClass('card-visible').siblings('.type-card').addClass('card-invisible');
      }

      // PERK FLASH - INCREMENT QUANTITY
      $("#quantity-plus").on("click", function(e) {
        e.preventDefault();
        fieldId = $('#perk_times');
        var currentVal = parseInt($(fieldId).val());
        if (!isNaN(currentVal)) {
          $(fieldId).val((currentVal + 1).toString());
        } else {
          $(fieldId).val('1');
        }
      });

      // PERK FLASH - DECREASE QUANTITY
      $("#quantity-minus").on("click", function(e) {
        e.preventDefault();
        fieldId = $('#perk_times');
        var currentVal = parseInt($(fieldId).val());
        if (!isNaN(currentVal) && currentVal > 0) {
          $(fieldId).val(currentVal - 1);
        } else {
          $(fieldId).val(0);
        }
      });

      // OPEN PERK APPEL ON CLICK
      $(".type-card").on("click", function() {
        var perkType = $(this).attr('id');
        $(this).find('.fa-plus').addClass('plus-animation');
        $('.dashboard-create-perk').scrollTop(0);
        $(".dashboard-overlay").removeClass('hidden');
        $("."+perkType).addClass('type-show');
        $(this).addClass('card-visible').siblings('.type-card').addClass('card-invisible');
      });

      // CLOSE PERK ON CLICK
      $(".close-create").on("click", function(e) {
        e.preventDefault;
        $('.fa-plus').removeClass('plus-animation');
        $(".dashboard-overlay").addClass('hidden');
        $(".perk-form-card").removeClass('type-show');
        $('.type-card').removeClass('card-invisible');
      });

      // REMOVE PERK ON CLICK OUTSIDE THE CARD
      $(".dashboard-overlay").on("click", function(e) {
        e.preventDefault;
        $(this).addClass('hidden');
        $(".perk-form-card").removeClass('type-show');
      });

      // SUPPLY BOOLEAN FIELDS
      $(".type-card").on("click", function(e) {
        e.preventDefault;
        var typePerk = $(this).val('div').attr('id');

        if (typePerk == "perk-appel") {
          $(".perk-appel #perk_appel").val("true");
          $(".perk-appel #perk_durable").val("false");
          $(".perk-appel #perk_flash").val("false");
        }
        if (typePerk == "perk-durable") {
          $(".perk-durable #perk_appel").val("false");
          $(".perk-durable #perk_durable").val("true");
          $(".perk-durable #perk_flash").val("false");
        }
        if (typePerk == "perk-flash") {
          $(".perk-flash #perk_appel").val("false");
          $(".perk-flash #perk_durable").val("false");
          $(".perk-flash #perk_flash").val("true");
        }
      });

      // PICTURE LOAD PREVIEW
      function readURL(file, classe) {
        var reader = new FileReader();
          reader.onload = function (e) {
            if ($("#"+classe).attr('src') === undefined) {
              $(".picture-container."+classe+" svg").remove();
              $(".picture-container."+classe).append('<img src=" " class="picture-perk" id="'+classe+'">')
            };
            $("#"+classe).attr('src', e.target.result);
          }
        reader.readAsDataURL(file);
      }
      $("#perk_appel_file").on("change", function(e) {
        e.preventDefault();
        var newFile = document.querySelector('#perk_appel_file').files[0];
        $("#perk_appel_file").parent().children().html(newFile.name);
        readURL(newFile, "perk-appel-preview");
      });
      $("#perk_durable_file").on("change", function(e) {
        e.preventDefault();
        var newFile = document.querySelector('#perk_durable_file').files[0];
        $("#perk_durable_file").parent().children().html(newFile.name);
        readURL(newFile, "perk-durable-preview");
      });
      $("#perk_flash_file").on("change", function(e) {
        e.preventDefault();
        var newFile = document.querySelector('#perk_flash_file').files[0];
        $("#perk_flash_file").parent().children().html(newFile.name);
        readURL(newFile, "perk-flash-preview");
      });
    });

  </script>

<% end %>
