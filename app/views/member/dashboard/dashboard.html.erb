<%= content_for(:title) do %>
  Autour de vous
<% end %>
<%= content_for(:description) do %>
  Découvrez les bons plans de nos partenaires !
<% end %>

<div class="container-fluid admin">
  <% if !current_user.active %>
    <div class="done-overlay waiting connexion-user">
      <div class="done-container">
        <div class="wrapper">
          <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
           viewBox="0 0 98.5 98.5" enable-background="new 0 0 98.5 98.5" xml:space="preserve">
            <path class="checkmark" fill="none" stroke-width="3" stroke-miterlimit="10" d="M81.7,17.8C73.5,9.3,62,4,49.2,4
          C24.3,4,4,24.3,4,49.2s20.3,45.2,45.2,45.2s45.2-20.3,45.2-45.2c0-8.6-2.4-16.6-6.5-23.4l0,0L45.6,68.2L24.7,47.3"/>
          </svg>
        </div>
        <span>Félicitations !<br><small>Votre compte Cforgood est créé.</small></span>
        <p>Votre espace sera très prochainement actif, surveillez votre boîte mail dans les jours à venir.</p>
        <%= link_to "À très vite !", destroy_user_session_path, method: :delete %>
      </div>
    </div>
  <% else %>
    <!-- SIDEBAR -->
    <%= render "member/dashboard/shared/sidebar" %>

    <!-- DASHBOARD CONTAINER -->
    <div class="dashboard">

      <div class="mobile-menu-overlay hidden"></div>

      <!-- MENU | NOTIFICATION -->
      <%= render 'components/menu/notification_center' %>

      <!-- FLASH | FIND PERK -->
      <div class="in-central-city hidden">
        <div class="flash">
          <i class="fa fa-bolt"></i>
        </div>
      </div>

      <!-- MENU | CATEGORY FILTER -->
      <%= render 'components/menu/search_category' %>

      <!-- ON MOBILE | WELCOME -->
      <div class="welcome-user">
          <% if current_user.picture.present? %>
            <%= image_tag avatar_url(current_user) %>
           <% else %>
            <%= image_tag "default_pic.png" %>
          <% end %>
         <span> Bienvenue
          <% if current_user.last_name != "" && current_user.last_name != nil %>
            <%= current_user.first_name %> <%= current_user.last_name.chars.first + "." %>
          <% elsif current_user.name != "" && current_user.name != nil %>
            <%= current_user.name.split(" ")[0] %></span>
          <% end %></span>
      </div>

      <!-- MAP -->
      <div id="map-dashboard" class="user-map-businesses" style="width: 100%;"></div>

    </div>
  <% end %>
</div>

<% content_for(:after_js) do %>

  <%= render 'components/map', geojson: @geojson %>

  <script>
    $(document).ready(function(){
      $('#open-notification').click(function(event) {
        $('.notification-center-overlay').toggleClass('hidden');
        $('.notifier').addClass('hidden');

        $('.search-category-overlay').addClass('hidden');
        $('.search-category').removeClass('is-open-max');
        $('.search-category').removeClass('is-open-min');

        $('.notification-center').toggleClass('is-open-max');
        $('.notification-panel').toggleClass('is-open-min');
      });

      $('.notification-center-overlay').click(function(event) {
        $(this).addClass('hidden');
        $('.notification-center').toggleClass('is-open-max');
        $('.notification-panel').toggleClass('is-open-min');
        $('.search-category').removeClass('is-open-max');
        $('.search-category').removeClass('is-open-min');
      });

      $('.in-central-city').click(function(event) {
        $('.flash').toggleClass('is-running');
      });

      $('#open-categories').click(function(event) {
        $('.search-category-overlay').toggleClass('hidden');
        $('.search-category').toggleClass('is-open-max');
        $('.category-item').toggleClass('is-open-min');
        $('.side-notification').removeClass('is-open-max');
        $('.notification-panel').removeClass('is-open-min');
      });

      $('.search-category-overlay').click(function(event) {
        $(this).addClass('hidden');
        $('.search-category').toggleClass('is-open-max');
        $('.search-category').toggleClass('is-open-min');
        $('.notification-center').removeClass('is-open-max');
        $('.notification-panel').removeClass('is-open-min');
      });

      $('.category-item').click(function(event) {
        var input = document.getElementsByClassName('category-item');
        if ($(this).val('div').attr('id') != 'categories-all') {
          $(this).toggleClass('is-selected');
          $('#categories-all').removeClass('is-selected');
          // SET VISIBLE SELECTED LAYERS
          var i;
          for (i = 0; i < input.length; i++) {
            var filter = input[i].getAttribute('id');
            if (map.getLayer(filter) != undefined) {
              map.setLayoutProperty(filter, 'visibility',
                input[i].classList.contains("is-selected") ? 'visible' : 'none');
            }
          }
        } else {
          $('.category-item').removeClass('is-selected');
          $('#categories-all').addClass('is-selected');
          // SET VISIBLE ALL LAYERS
          var i;
          for (i = 0; i < input.length; i++) {
            var filter = input[i].getAttribute('id');
            if (map.getLayer(filter) != undefined) {
              map.setLayoutProperty(filter, 'visibility', 'visible');
            }
          }
        }
      });
    });

  </script>
<% end %>
